<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Detail Buku</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="detail-page">
  <div class="detail-card">

    <h1 class="detail-title" id="title">Memuat...</h1>

    <div class="cover-wrapper">
      <img id="cover" alt="Cover Buku">
    </div>

    <div class="info-row">
      <div class="info-box">
        <span>Author</span>
        <strong id="author">-</strong>
      </div>
      <div class="info-box">
        <span>Kategori</span>
        <strong id="category">Fiksi</strong>
      </div>
      <div class="info-box">
        <span>Denda / Hari</span>
        <strong id="finePerDayText">Rp 1.000</strong>
      </div>
    </div>

    <div class="synopsis-box">
      <h3>Sinopsis</h3>
      <p id="description">Memuat...</p>
    </div>

    <div class="action-row">
      <button class="btn-back" id="btnBack">‚Üê Kembali</button>
      <button class="btn-borrow" id="btnBorrow" onclick="goToBorrowForm()">üìö Pinjam</button>
    </div>

  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const workId = params.get("id");
const authorParam = params.get("author");
const isAdminView = params.get("role") === "admin";

const btnBack = document.getElementById("btnBack");
const btnBorrow = document.getElementById("btnBorrow");

if (isAdminView) {
  btnBorrow.style.display = "none";
  btnBack.onclick = () => window.location.href = "admin-dashboard.html";
} else {
  btnBack.onclick = () => history.back();
}

if (!workId) {
  document.getElementById("title").innerText = "ID buku tidak ditemukan";
}

document.getElementById("author").innerText =
  authorParam ? decodeURIComponent(authorParam) : "-";

let bookData = {};

if (workId) {
  fetch(`https://openlibrary.org/works/${workId}.json`)
    .then(res => res.json())
    .then(data => {
      bookData = data;

      document.getElementById("title").innerText = data.title || "Tanpa judul";

      document.getElementById("description").innerText =
        typeof data.description === "string"
          ? data.description
          : (data.description?.value ?? "Tidak ada sinopsis");

      if (data.covers?.length) {
        document.getElementById("cover").src =
          `https://covers.openlibrary.org/b/id/${data.covers[0]}-L.jpg`;
      } else {
        document.getElementById("cover").style.display = "none";
      }
    })
    .catch(() => {
      document.getElementById("title").innerText = "Gagal memuat detail buku";
    });
}

/* ‚úÖ PINJAM -> ke borrow-form.html dulu */
function goToBorrowForm() {
  if (isAdminView) return;

  // cek login member (token)
  const token = localStorage.getItem("token");
  if (!token) {
    Swal.fire({
      icon: "warning",
      title: "Harus login dulu",
      text: "Silakan login sebagai member sebelum meminjam."
    }).then(() => window.location.href = "login.html");
    return;
  }

  const api_book_id = workId;
  const title = (bookData.title || document.getElementById("title").innerText || "").trim();
  const author = authorParam ? decodeURIComponent(authorParam) : (document.getElementById("author").innerText || "");

  if (!api_book_id || !title || title === "Memuat..." || title === "Gagal memuat detail buku") {
    Swal.fire({
      icon: "error",
      title: "Data tidak lengkap",
      text: "ID buku atau judul tidak valid."
    });
    return;
  }

  // simpan data buku untuk dipakai di borrow-form.html (sesuai punyamu)
  localStorage.setItem("borrowBook", JSON.stringify({
    api_book_id,
    title,
    author
  }));

  window.location.href = "borrow-form.html";
}
</script>

</body>
</html>
