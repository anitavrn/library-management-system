<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Detail Buku</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="detail-page">
  <div class="detail-card">

    <!-- JUDUL -->
    <h1 class="detail-title" id="title">Memuat...</h1>

    <!-- COVER -->
    <div class="cover-wrapper">
      <img id="cover" alt="Cover Buku">
    </div>

    <!-- INFO -->
    <div class="info-row">
      <div class="info-box">
        <span>Author</span>
        <strong id="author">-</strong>
      </div>
      <div class="info-box">
        <span>Kategori</span>
        <strong id="category">Fiksi</strong>
      </div>
      <div class="info-box">
        <span>Denda / Hari</span>
        <strong id="finePerDayText">Rp 1.000</strong>
      </div>
    </div>

    <!-- SINOPSIS -->
    <div class="synopsis-box">
      <h3>Sinopsis</h3>
      <p id="description">Memuat...</p>
    </div>

    <!-- BUTTON -->
    <div class="action-row">
      <button class="btn-back" id="btnBack">‚Üê Kembali</button>
      <button class="btn-borrow" id="btnBorrow" onclick="pinjam()">üìö Pinjam</button>
    </div>

  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "http://127.0.0.1:8000/api";
const MEMBER_TOKEN_KEY = "token"; // token member

/* =========================
   GET PARAMS
========================= */
const params = new URLSearchParams(window.location.search);
const workId = params.get("id");              // contoh: OL505944W ==> api_book_id
const authorParam = params.get("author");
const isAdminView = params.get("role") === "admin"; // ‚úÖ MODE ADMIN DARI URL

/* =========================
   MODE ADMIN (HIDE PINJAM + BACK KE ADMIN)
========================= */
const btnBack = document.getElementById("btnBack");
const btnBorrow = document.getElementById("btnBorrow");

if (isAdminView) {
  // sembunyikan pinjam untuk admin
  btnBorrow.style.display = "none";

  // tombol kembali diarahkan ke dashboard admin
  btnBack.onclick = () => window.location.href = "admin-dashboard.html";
} else {
  // default: kembali seperti biasa
  btnBack.onclick = () => history.back();
}

/* =========================
   VALIDASI ID
========================= */
if (!workId) {
  document.getElementById("title").innerText = "ID buku tidak ditemukan";
}

/* =========================
   SET AUTHOR DARI URL
========================= */
document.getElementById("author").innerText =
  authorParam ? decodeURIComponent(authorParam) : "-";

let bookData = {};

/* =========================
   FETCH DETAIL BUKU
========================= */
if (workId) {
  fetch(`https://openlibrary.org/works/${workId}.json`)
    .then(res => res.json())
    .then(data => {
      bookData = data;

      document.getElementById("title").innerText = data.title || "Tanpa judul";

      document.getElementById("description").innerText =
        typeof data.description === "string"
          ? data.description
          : (data.description?.value ?? "Tidak ada sinopsis");

      if (data.covers?.length) {
        document.getElementById("cover").src =
          `https://covers.openlibrary.org/b/id/${data.covers[0]}-L.jpg`;
      } else {
        document.getElementById("cover").style.display = "none";
      }
    })
    .catch(() => {
      document.getElementById("title").innerText = "Gagal memuat detail buku";
    });
}

/* =========================
   PINJAM (MEMBER ONLY)
========================= */
function pinjam() {
  // ‚úÖ safety: kalau admin somehow akses, stop
  if (isAdminView) return;

  const token = localStorage.getItem(MEMBER_TOKEN_KEY);
  if (!token) {
    Swal.fire({
      icon: "warning",
      title: "Harus login dulu",
      text: "Silakan login sebagai member sebelum meminjam."
    }).then(() => window.location.href = "login.html");
    return;
  }

  const api_book_id = workId;
  const title = (bookData.title || document.getElementById("title").innerText || "").trim();
  const author = authorParam
    ? decodeURIComponent(authorParam)
    : (document.getElementById("author").innerText || null);

  if (!api_book_id || !title || title === "Memuat..." || title === "Gagal memuat detail buku") {
    Swal.fire({
      icon: "error",
      title: "Data tidak lengkap",
      text: "ID buku atau judul tidak valid."
    });
    return;
  }

  fetch(`${API_URL}/transactions`, {
    method: "POST",
    headers: {
      "Accept": "application/json",
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ api_book_id, title, author })
  })
  .then(async res => {
    const data = await res.json();
    return { status: res.status, data };
  })
  .then(({ status, data }) => {
    if (status !== 201) {
      Swal.fire({
        icon: "error",
        title: "Gagal meminjam",
        text: data.message || "Request peminjaman gagal."
      });
      return;
    }

    Swal.fire({
      icon: "success",
      title: "Request peminjaman berhasil üéâ",
      text: "Menunggu konfirmasi librarian.",
      confirmButtonText: "OK"
    }).then(() => {
      window.location.href = "dashboard.html";
    });
  })
  .catch(() => {
    Swal.fire({
      icon: "error",
      title: "Server Error",
      text: "Tidak bisa terhubung ke backend."
    });
  });
}
</script>

</body>
</html>
